<Window
    x:Class="MyAthenaeio.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:MyAthenaeio.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="myAthenaeio - Book Scanner"
    Width="1200"
    Height="750"
    Activated="Window_Activated"
    Closing="Window_Closing"
    Deactivated="Window_Deactivated"
    StateChanged="Window_StateChanged"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Window.Resources>
        <ResourceDictionary Source="/Resources/Styles.xaml" />
    </Window.Resources>

    <Grid Background="{StaticResource DarkAcademiaBackground}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <!--  Menu  -->
        <Menu Grid.Row="0" VerticalAlignment="Top">
            <MenuItem Header="_File">
                <MenuItem Click="ExportLibrary_Click" Header="_Export Library..." />
                <MenuItem Click="ImportLibrary_Click" Header="_Import Library..." />
                <Separator />
                <MenuItem Click="RestoreFromBackup_Click" Header="_Restore from Backup..." />
                <Separator />
                <MenuItem Click="ResetDatabase_Click" Header="Reset _Database..." />
                <Separator />
                <MenuItem Click="Exit_Click" Header="E_xit" />
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Click="ManageBorrowers_Click" Header="Manage _Borrowers" />
                <MenuItem Click="ManageGenres_Click" Header="Manage _Genres" />
                <MenuItem Click="ManageTags_Click" Header="Manage _Tags" />
                <MenuItem Click="ManageCollections_Click" Header="Manage _Collections" />
                <Separator />
                <MenuItem Click="Settings_Click" Header="_Settings" />
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Click="ViewHelp_Click" Header="View _Help" />
                <MenuItem Click="ScannerHelp_Click" Header="_Scanner Guide" />
                <MenuItem Click="LoanHelp_Click" Header="_Loaning Guide" />
                <MenuItem Click="TroubleshootingHelp_Click" Header="_Troubleshooting" />
                <Separator />
                <MenuItem Click="CheckForUpdates_Click" Header="Check for _Updates" />
                <Separator />
                <MenuItem Click="About_Click" Header="_About" />
            </MenuItem>
        </Menu>

        <!--  Header  -->
        <Border Grid.Row="1" Style="{StaticResource DarkAcademiaBorderStyle}">
            <StackPanel>
                <TextBlock
                    FontSize="24"
                    Style="{StaticResource HeaderTextBlockStyle}"
                    Text="myAthenaeio" />
                <TextBlock
                    FontSize="12"
                    Opacity="0.9"
                    Text="Book Scanner &amp; Library Manager" />
            </StackPanel>
        </Border>
        <!--  Main Content  -->
        <TabControl Grid.Row="2" Margin="10">
            <TabItem Header="View Library">
                <Grid Margin="10">
                    <!--  Search and Actions  -->
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Margin="0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <Label
                            Grid.Column="0"
                            Margin="0,0,5,0"
                            Content="Filters:" />
                        <ComboBox
                            x:Name="AuthorsComboBox"
                            Grid.Column="1"
                            Margin="5,0"
                            DisplayMemberPath="Display"
                            SelectedIndex="0"
                            SelectedValuePath="Value"
                            SelectionChanged="AuthorsComboBox_SelectionChanged" />
                        <ComboBox
                            x:Name="GenresComboBox"
                            Grid.Column="2"
                            Margin="5,0"
                            DisplayMemberPath="Display"
                            SelectedIndex="0"
                            SelectedValuePath="Value"
                            SelectionChanged="GenresComboBox_SelectionChanged" />
                        <ComboBox
                            x:Name="TagsComboBox"
                            Grid.Column="3"
                            Margin="5,0"
                            DisplayMemberPath="Display"
                            SelectedIndex="0"
                            SelectedValuePath="Value"
                            SelectionChanged="TagsComboBox_SelectionChanged" />
                        <ComboBox
                            x:Name="CollectionsComboBox"
                            Grid.Column="4"
                            Margin="5,0,0,0"
                            DisplayMemberPath="Display"
                            SelectedIndex="0"
                            SelectedValuePath="Value"
                            SelectionChanged="CollectionsComboBox_SelectionChanged" />
                    </Grid>

                    <Grid Grid.Row="1" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0" Margin="0,0,10,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox
                                x:Name="SearchTextBox"
                                Grid.Column="0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                KeyDown="SearchTextBox_KeyDown"
                                TextChanged="SearchTextBox_TextChanged" />
                            <TextBlock
                                Grid.Column="0"
                                Margin="15,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                Foreground="{StaticResource DarkAcademiaTextMuted}"
                                IsHitTestVisible="False"
                                Text="Search by title, author, or ISBN...">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ElementName=SearchTextBox, Path=Text}" Value="">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                        </Grid>

                        <Button
                            x:Name="SearchButton"
                            Grid.Column="1"
                            Click="SearchButton_Click"
                            Content="Search" />

                        <Button
                            x:Name="AddManualEntryButton"
                            Grid.Column="2"
                            Click="AddManualEntryButton_Click"
                            Content="Add Book Manually" />

                    </Grid>

                    <!--  Books Grid  -->
                    <DataGrid
                        x:Name="BooksDataGrid"
                        Grid.Row="2"
                        AutoGenerateColumns="False"
                        ItemsSource="{Binding}"
                        MouseDoubleClick="DataGrid_MouseDoubleClick"
                        RowHeight="85">

                        <DataGrid.Columns>

                            <!--  Cover Image with Placeholder Support  -->
                            <DataGridTemplateColumn Width="80" Header="Cover">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border
                                            Width="60"
                                            Height="90"
                                            Margin="5"
                                            BorderBrush="{StaticResource DarkAcademiaBorder}"
                                            BorderThickness="1"
                                            CornerRadius="2">
                                            <Image
                                                Source="{Binding CoverImageUrl, Converter={StaticResource BookCoverConverter}}"
                                                Stretch="Uniform"
                                                StretchDirection="DownOnly" />
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn
                                Width="*"
                                MinWidth="200"
                                Binding="{Binding Title}"
                                Header="Title" />

                            <DataGridTextColumn
                                Width="200"
                                Binding="{Binding AuthorsDisplay, Mode=OneWay}"
                                Header="Authors"
                                IsReadOnly="True" />

                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding ISBN}"
                                Header="ISBN" />

                            <DataGridTextColumn
                                Width="150"
                                Binding="{Binding Publisher}"
                                Header="Publisher" />

                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding PublicationYear}"
                                Header="Published" />

                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding TotalCopies}"
                                Header="Copies" />

                            <DataGridTemplateColumn Width="150" Header="Actions">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button
                                            Margin="2"
                                            Padding="5,2"
                                            Click="ViewDetailsButton_Click"
                                            Content="View Details" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
            <TabItem Header="Scan Books">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!--  Scanner Input Field  -->
                    <Border
                        Grid.Row="0"
                        Margin="0,0,0,20"
                        Padding="15"
                        BorderBrush="{StaticResource DarkAcademiaBorder}"
                        BorderThickness="2"
                        CornerRadius="5">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontWeight="SemiBold"
                                Text="Scan or Type ISBN:" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBox
                                    x:Name="ScannerInputField"
                                    Grid.Column="0"
                                    Padding="8"
                                    FontSize="16"
                                    PreviewKeyDown="ScannerInputField_PreviewKeyDown" />
                                <Button
                                    x:Name="ProcessISBNButton"
                                    Grid.Column="1"
                                    Width="120"
                                    Margin="10,0,0,0"
                                    Click="ProcessISBNButton_Click"
                                    Content="Process ISBN" />
                            </Grid>
                        </StackPanel>
                    </Border>
                    <!--  Scan Log  -->
                    <GroupBox
                        Grid.Row="1"
                        Padding="0"
                        Header="Scan History">
                        <ListView
                            x:Name="ScanLogList"
                            HorizontalContentAlignment="Stretch"
                            MouseDoubleClick="ScanLogList_MouseDoubleClick"
                            ScrollViewer.CanContentScroll="True"
                            ScrollViewer.ScrollChanged="ScanLogList_ScrollChanged"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0" />
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Padding="10,8"
                                        BorderBrush="{StaticResource DarkAcademiaBorder}"
                                        BorderThickness="0,0,0,1">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <!--  Highlight failed scans  -->
                                                    <DataTrigger Binding="{Binding WasSuccessful}" Value="False">
                                                        <Setter Property="Background" Value="{StaticResource DarkAcademiaPanelMuted}" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="60" />
                                                <ColumnDefinition Width="90" />
                                                <ColumnDefinition Width="150" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="250" />
                                                <ColumnDefinition Width="80" />
                                            </Grid.ColumnDefinitions>

                                            <!--  Cover Image  -->
                                            <Border
                                                Grid.Column="0"
                                                Width="50"
                                                Height="75"
                                                VerticalAlignment="Center"
                                                Background="{StaticResource DarkAcademiaPanel}"
                                                ClipToBounds="True"
                                                CornerRadius="2">
                                                <Grid>
                                                    <Image
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Source="{Binding Cover}"
                                                        Stretch="UniformToFill" />
                                                    <!--  Error Icon Overlay  -->
                                                    <Border
                                                        Background="{StaticResource DarkAcademiaOverlay}"
                                                        CornerRadius="2"
                                                        Visibility="{Binding WasSuccessful, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                                        <TextBlock
                                                            HorizontalAlignment="Center"
                                                            VerticalAlignment="Center"
                                                            FontFamily="Segoe MDL2 Assets"
                                                            FontSize="24"
                                                            Foreground="{StaticResource DarkAcademiaLightRed}"
                                                            Text="&#xE783;" />
                                                    </Border>
                                                </Grid>
                                            </Border>

                                            <!--  Timestamp  -->
                                            <TextBlock
                                                Grid.Column="1"
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                Foreground="{StaticResource DarkAcademiaTextMuted}"
                                                Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" />

                                            <!--  Barcode  -->
                                            <TextBlock
                                                Grid.Column="2"
                                                Margin="10,0"
                                                VerticalAlignment="Center"
                                                FontFamily="Consolas"
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Text="{Binding Barcode}" />

                                            <!--  Title or Error Message  -->
                                            <StackPanel
                                                Grid.Column="3"
                                                Margin="10,0"
                                                VerticalAlignment="Center">
                                                <TextBlock
                                                    Foreground="{StaticResource DarkAcademiaText}"
                                                    Text="{Binding Title}"
                                                    TextTrimming="CharacterEllipsis"
                                                    Visibility="{Binding WasSuccessful, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                                <TextBlock
                                                    FontWeight="SemiBold"
                                                    Foreground="{StaticResource DarkAcademiaRed}"
                                                    Text="{Binding UserFriendlyError}"
                                                    TextWrapping="Wrap"
                                                    Visibility="{Binding WasSuccessful, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                                            </StackPanel>

                                            <!--  Action Buttons  -->
                                            <StackPanel
                                                Grid.Column="4"
                                                Margin="10,0"
                                                VerticalAlignment="Center"
                                                Orientation="Horizontal">

                                                <Button
                                                    Height="30"
                                                    Margin="0,0,5,0"
                                                    Click="AddToLibrary_Click"
                                                    Visibility="{Binding ShowAddButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                    <Button.Content>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding ButtonText}" />
                                                        </StackPanel>
                                                    </Button.Content>
                                                    <Button.Style>
                                                        <Style BasedOn="{StaticResource ScanLogAddButtonStyle}" TargetType="Button">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsInLibrary}" Value="True">
                                                                    <Setter Property="Background" Value="{StaticResource DarkAcademiaGreenMuted}" />
                                                                    <Setter Property="ToolTip" Value="Click to view book details" />
                                                                </DataTrigger>
                                                                <MultiDataTrigger>
                                                                    <MultiDataTrigger.Conditions>
                                                                        <Condition Binding="{Binding RelativeSource={RelativeSource Self}, Path=IsMouseOver}" Value="True" />
                                                                        <Condition Binding="{Binding IsInLibrary}" Value="True" />
                                                                    </MultiDataTrigger.Conditions>
                                                                    <Setter Property="Background" Value="{StaticResource DarkAcademiaGreenMuted}" />
                                                                </MultiDataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </Button.Style>
                                                </Button>

                                                <Button
                                                    Height="30"
                                                    Margin="0,0,5,0"
                                                    Click="RetryScan_Click"
                                                    Content="Retry"
                                                    Style="{StaticResource ScanLogRetryButtonStyle}"
                                                    Visibility="{Binding ShowRetryButton, Converter={StaticResource BooleanToVisibilityConverter}}" />

                                                <Button
                                                    Height="30"
                                                    Click="AddManuallyFromScan_Click"
                                                    Content="Add Manually"
                                                    Style="{StaticResource ScanLogManualButtonStyle}"
                                                    Visibility="{Binding ShowManualAddButton, Converter={StaticResource BooleanToVisibilityConverter}}" />
                                            </StackPanel>

                                            <!--  Source  -->
                                            <TextBlock
                                                Grid.Column="5"
                                                Margin="10,0,0,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center"
                                                FontSize="11"
                                                Foreground="{StaticResource DarkAcademiaText}"
                                                Text="{Binding Source}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </GroupBox>
                </Grid>
            </TabItem>
        </TabControl>
        <!--  Status Bar  -->
        <Border
            Grid.Row="3"
            Padding="10,5"
            Background="{StaticResource DarkAcademiaBackground}"
            BorderBrush="{StaticResource DarkAcademiaBorder}"
            BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock
                    x:Name="StatusText"
                    Grid.Column="0"
                    VerticalAlignment="Center"
                    Foreground="{StaticResource DarkAcademiaText}"
                    Text="Ready to scan" />
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,5,0"
                        VerticalAlignment="Center"
                        Foreground="{StaticResource DarkAcademiaText}"
                        Text="Total scans: " />
                    <TextBlock
                        x:Name="ScanCountText"
                        VerticalAlignment="Center"
                        FontWeight="Bold"
                        Foreground="{StaticResource DarkAcademiaGold}"
                        Text="0" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
