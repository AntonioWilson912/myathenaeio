<Window
    x:Class="MyAthenaeio.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:MyAthenaeio.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="myAthenaeio - Book Scanner"
    Width="1200"
    Height="750"
    Activated="Window_Activated"
    Closing="Window_Closing"
    Deactivated="Window_Deactivated"
    StateChanged="Window_StateChanged"
    WindowStartupLocation="CenterScreen"
    mc:Ignorable="d">
    <Window.Resources>
        <ResourceDictionary Source="/Resources/Styles.xaml" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <!--  Header  -->
        <Border
            Grid.Row="0"
            Padding="15"
            Background="{StaticResource RusticAccent}">
            <StackPanel>
                <TextBlock
                    FontSize="24"
                    FontWeight="Bold"
                    Foreground="White"
                    Text="myAthenaeio" />
                <TextBlock
                    FontSize="12"
                    Foreground="White"
                    Opacity="0.9"
                    Text="Book Scanner &amp; Library Manager" />
            </StackPanel>
        </Border>
        <!--  Main Content  -->
        <TabControl Grid.Row="1" Margin="10">
            <TabItem Header="View Library">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!--  Search and Actions  -->
                    <Grid Grid.Row="0" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Grid Grid.Column="0" Margin="0,0,10,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox
                                x:Name="SearchTextBox"
                                Grid.Column="0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                KeyDown="SearchTextBox_KeyDown"
                                TextChanged="SearchTextBox_TextChanged" />
                            <TextBlock
                                Grid.Column="0"
                                Margin="15,0"
                                VerticalAlignment="Center"
                                FontSize="16"
                                Foreground="Gray"
                                IsHitTestVisible="False"
                                Text="Search by title, author, or ISBN...">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ElementName=SearchTextBox, Path=Text}" Value="">
                                                <Setter Property="Visibility" Value="Visible" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <Button
                                x:Name="SearchButton"
                                Grid.Column="1"
                                Width="100"
                                Margin="5,0,0,0"
                                Click="SearchButton_Click"
                                Content="Search" />
                        </Grid>

                        <Button
                            x:Name="AddManualEntryButton"
                            Grid.Column="1"
                            Margin="0,0,10,0"
                            Click="AddManualEntryButton_Click"
                            Content="Add Book Manually" />

                        <Button
                            x:Name="RefreshButton"
                            Grid.Column="2"
                            Click="RefreshButton_Click"
                            Content="Refresh" />
                    </Grid>

                    <!--  Books Grid  -->
                    <DataGrid
                        x:Name="BooksDataGrid"
                        Grid.Row="1"
                        AutoGenerateColumns="False"
                        ItemsSource="{Binding}"
                        MouseDoubleClick="DataGrid_MouseDoubleClick"
                        RowHeight="85">

                        <DataGrid.Columns>

                            <!--  ✅ Cover Image with Placeholder Support  -->
                            <DataGridTemplateColumn Width="80" Header="Cover">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border
                                            Width="60"
                                            Height="90"
                                            Margin="5"
                                            BorderBrush="#CCCCCC"
                                            BorderThickness="1"
                                            CornerRadius="2">
                                            <Image
                                                Source="{Binding CoverImageUrl, Converter={StaticResource BookCoverConverter}}"
                                                Stretch="Uniform"
                                                StretchDirection="DownOnly" />
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn
                                Width="*"
                                MinWidth="200"
                                Binding="{Binding Title}"
                                Header="Title" />

                            <DataGridTextColumn
                                Width="200"
                                Binding="{Binding AuthorsDisplay, Mode=OneWay}"
                                Header="Authors"
                                IsReadOnly="True" />

                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding ISBN}"
                                Header="ISBN" />

                            <DataGridTextColumn
                                Width="150"
                                Binding="{Binding Publisher}"
                                Header="Publisher" />

                            <DataGridTextColumn
                                Width="120"
                                Binding="{Binding PublicationYear}"
                                Header="Published" />

                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding TotalCopies}"
                                Header="Copies" />

                            <DataGridTemplateColumn Width="150" Header="Actions">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button
                                            Margin="2"
                                            Click="ViewDetailsButton_Click"
                                            Content="View Details" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
            <TabItem Header="Scan Books">
                <Grid Margin="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <!--  Scanner Input Field  -->
                    <Border
                        Grid.Row="0"
                        Margin="0,0,0,20"
                        Padding="15"
                        BorderBrush="#2196F3"
                        BorderThickness="2"
                        CornerRadius="5">
                        <StackPanel>
                            <TextBlock
                                Margin="0,0,0,10"
                                FontWeight="SemiBold"
                                Text="Scan or Type ISBN:" />
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <TextBox
                                    x:Name="ScannerInputField"
                                    Grid.Column="0"
                                    Padding="8"
                                    FontSize="16"
                                    PreviewKeyDown="ScannerInputField_PreviewKeyDown" />
                                <Button
                                    x:Name="ProcessISBNButton"
                                    Grid.Column="1"
                                    Width="120"
                                    Margin="10,0,0,0"
                                    Content="Process ISBN" />
                            </Grid>
                        </StackPanel>
                    </Border>
                    <!--  Scan Log  -->
                    <GroupBox
                        Grid.Row="1"
                        Padding="0"
                        Header="Scan History">
                        <ListView
                            x:Name="ScanLogList"
                            HorizontalContentAlignment="Stretch"
                            MouseDoubleClick="ScanLogList_MouseDoubleClick"
                            ScrollViewer.CanContentScroll="True"
                            ScrollViewer.ScrollChanged="ScanLogList_ScrollChanged"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0" />
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <Border
                                        Padding="10,8"
                                        BorderBrush="#E0E0E0"
                                        BorderThickness="0,0,0,1">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="60" />
                                                <ColumnDefinition Width="90" />
                                                <ColumnDefinition Width="140" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="130" />
                                                <ColumnDefinition Width="80" />
                                            </Grid.ColumnDefinitions>
                                            <Border
                                                Grid.Column="0"
                                                Width="50"
                                                Height="75"
                                                VerticalAlignment="Center"
                                                Background="#F5F5F5"
                                                ClipToBounds="True"
                                                CornerRadius="2">
                                                <Image
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center"
                                                    Source="{Binding Cover}"
                                                    Stretch="UniformToFill" />
                                            </Border>
                                            <TextBlock
                                                Grid.Column="1"
                                                Margin="10,0,0,0"
                                                VerticalAlignment="Center"
                                                Foreground="Gray"
                                                Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}" />
                                            <TextBlock
                                                Grid.Column="2"
                                                Margin="10,0"
                                                VerticalAlignment="Center"
                                                FontFamily="Consolas"
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Text="{Binding Barcode}" />
                                            <TextBlock
                                                Grid.Column="3"
                                                Margin="10,0"
                                                VerticalAlignment="Center"
                                                Foreground="Gray"
                                                Text="{Binding Title}"
                                                TextTrimming="CharacterEllipsis" />
                                            <Button
                                                Grid.Column="4"
                                                Height="30"
                                                Margin="10,0"
                                                VerticalAlignment="Center"
                                                Click="AddToLibrary_Click"
                                                Content="{Binding ButtonText}"
                                                IsEnabled="{Binding ButtonEnabled}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="#2196F3" />
                                                        <Setter Property="Foreground" Value="White" />
                                                        <Setter Property="BorderThickness" Value="0" />
                                                        <Setter Property="Padding" Value="10,5" />
                                                        <Setter Property="Cursor" Value="Hand" />
                                                        <Style.Triggers>
                                                            <Trigger Property="IsEnabled" Value="False">
                                                                <Setter Property="Background" Value="#E0E0E0" />
                                                                <Setter Property="Foreground" Value="#757575" />
                                                            </Trigger>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#1976D2" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            <TextBlock
                                                Grid.Column="5"
                                                Margin="10,0,0,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Center"
                                                FontSize="11"
                                                Foreground="Gray"
                                                Text="{Binding Source}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </GroupBox>
                </Grid>
            </TabItem>
            <!--  Settings Tab  -->
            <TabItem Header="⚙️ Settings">
                <ScrollViewer>
                    <StackPanel MaxWidth="600" Margin="20">
                        <GroupBox Padding="15" Header="Scanner Settings">
                            <StackPanel>
                                <CheckBox
                                    x:Name="BackgroundScanningCheckbox"
                                    Margin="0,5"
                                    Checked="BackgroundScanning_Changed"
                                    Content="Enable background scanning"
                                    IsChecked="False"
                                    Unchecked="BackgroundScanning_Changed" />
                                <TextBlock
                                    Margin="25,0,0,15"
                                    FontSize="11"
                                    Foreground="Gray"
                                    Text="Scan books even when app is minimized"
                                    TextWrapping="Wrap" />
                                <TextBlock
                                    Margin="0,10,0,5"
                                    FontWeight="SemiBold"
                                    Text="Current Mode:" />
                                <TextBlock
                                    x:Name="CurrentModeText"
                                    FontSize="14"
                                    Foreground="#2196F3"
                                    Text="Focused Field Only" />
                            </StackPanel>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
        <!--  Status Bar  -->
        <Border
            Grid.Row="2"
            Padding="10,5"
            Background="#F5F5F5"
            BorderBrush="#E0E0E0"
            BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock
                    x:Name="StatusText"
                    Grid.Column="0"
                    VerticalAlignment="Center"
                    Text="Ready to scan" />
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,5,0"
                        VerticalAlignment="Center"
                        Text="Total scans: " />
                    <TextBlock
                        x:Name="ScanCountText"
                        VerticalAlignment="Center"
                        FontWeight="Bold"
                        Text="0" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
